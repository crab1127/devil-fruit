define("mmPromise",["avalon"],function(e){function a(e){return this.then(e)}function f(e){return this.then(null,e)}var t;if(/native code/.test(window.Promise))t=window.Promise;else{var n=function(e){this._callbacks=[];var t=this;if(typeof this!="object")throw new TypeError("Promises must be constructed via new");if(typeof e!="function")throw new TypeError("not a function");e(function(e){i(t,e)},function(e){s(t,e)})},r=typeof window.setImmediate=="function"?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)};n.resolve=function(e){return new n(function(t){t(e)})},n.reject=function(e){return new n(function(t,n){n(e)})},n.prototype={constructor:n,_state:"pending",_fired:!1,_fire:function(e,t){if(this._state==="rejected"){if(typeof t!="function")throw this._value;t(this._value)}else typeof e=="function"&&e(this._value)},_then:function(e,t){if(this._fired){var n=this;r(function(){n._fire(e,t)})}else this._callbacks.push({onSuccess:e,onFail:t})},then:function(e,t){var r=this;return new n(function(n,i){r._then(function(t){if(typeof e=="function")try{t=e(t)}catch(r){i(r);return}n(t)},function(e){if(typeof t=="function"){try{e=t(e)}catch(r){i(r);return}n(e)}else i(e)})})},done:a,"catch":f,fail:f};function i(e,t){if(e._state!=="pending")return;e._state="fulfilled";if(t&&typeof t.then=="function"){var r=t instanceof n?"_then":"then";t[r](function(t){o(e,t)},function(t){e._state="rejected",o(e,t)})}else o(e,t)}function s(e,t){if(e._state!=="pending")return;e._state="rejected",o(e,t)}function o(e,t){e._fired=!0,e._value=t,r(function(){e._callbacks.forEach(function(t){e._fire(t.onSuccess,t.onFail)})})}function u(e,t){t=Array.isArray(t)?t:[];var r=0,i=[],s;return new n(function(n,o){function u(u,a){u.then(function(o){if(!s){i[a]=o,r++;if(e||r>=t.length)n(e?o:i),s=!0}},function(e){s=!0,o(e)})}t.length||n();for(var a=0,f=t.length;a<f;a++)u(t[a],a)})}n.all=function(e){return u(!1,e)},n.race=function(e){return u(!0,e)},t=n}return t.prototype.done=a,t.prototype.fail=f,t.any=t.race,t.defer||(t.defer=function(){var e={};return e.promise=new this(function(t,n){e.resolve=t,e.reject=n}),e}),window.Promise=e.Promise=t});